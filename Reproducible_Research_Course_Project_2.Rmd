---
title: "Reproducible Research Course Project 2"
author: "Amber Zhang"
date: "2018Äê10ÔÂ15ÈÕ"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Storms Exploration Based on the US National Oceanic and Atmospheric Administration's (NOAA)
### **Synopsis**
Storms and other severe weather events can cause both public health and economic
problems for communities and municipalities. Many severe events can result in 
fatalities, injuries, and property damage, and preventing such outcomes to the 
extent possible is a key concern.

This project involves exploring the U.S. National Oceanic and Atmospheric 
Administration's (NOAA) storm database. The database explored in this study 
tracks characteristics of major storms and weather events in the United States, 
including when and where they occur, as well as estimates of any fatalities, 
injuries, and property damage.

The basic goal of this project is to explore the NOAA Storm Database and answer 
some basic questions about severe weather events.


### **Data Processing **
#### Read in data

```{r message=FALSE}
packages <- c("lubridate", "data.table", "knitr", "ggplot2")
lapply(packages, library, character.only = TRUE)
```


```{r, cache=TRUE}
url <- "http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
if(!file.exists("Stormdata.csv.bz2")) 
{download.file(url, destfile = "Stormdata.csv.bz2")}
Sys.setlocale("LC_ALL", "English")
stormData <- read.csv("Stormdata.csv.bz2")
stormData <- as.data.table(stormData)
```

#### Target data subsetting

```{r}
# Subset data after 1996
stormData$BGN_DATE <- as.Date(stormData$BGN_DATE, format = "%m/%d/%Y")
after96 <- stormData[stormData$BGN_DATE >= ymd(19960101),]
# Selecting columns
filtercols <- after96[,c("EVTYPE", "FATALITIES", "INJURIES", "PROPDMG", "PROPDMGEXP",
                "CROPDMG", "CROPDMGEXP")]
# Filtering occurred injuries or fatalities
filter0values <- with(filtercols,filtercols[(EVTYPE != "?" & 
                                     (INJURIES > 0 | FATALITIES > 0 |
                                              PROPDMG > 0 | CROPDMG > 0)),])
stormDT <- filter0values

```


#### Cleaning data

```{r}
# EVTYPE
stormDT$EVTYPE <- toupper(stormDT$EVTYPE)
stormDT$EVTYPE <- gsub(".*(WIND).*", "WIND", stormDT$EVTYPE)
stormDT$EVTYPE <- gsub(".*(FIRE).*", "FIRE", stormDT$EVTYPE)
stormDT$EVTYPE <- gsub(".*(HEAT).*", "HEAT", stormDT$EVTYPE)
stormDT$EVTYPE <- gsub(".*(FLOOD).*", "FLOOD", stormDT$EVTYPE)
stormDT$EVTYPE <- gsub(".*(SNOW).*", "SNOW", stormDT$EVTYPE)
stormDT$EVTYPE <- gsub(".*(LIGHTNING).*", "LIGHTNING", stormDT$EVTYPE)
stormDT$EVTYPE <- as.factor(stormDT$EVTYPE)
str(stormDT)
```


```{r}
#  PROPDMGEXP & CROPDMGEXP
unique(stormDT$PROPDMGEXP)
unique(stormDT$CROPDMGEXP)
stormDT$PROPDMGEXP<- gsub(pattern = "?|-|+", replacement = "0" ,stormDT$PROPDMGEXP)
stormDT$PROPDMGEXP<- gsub("1"    , "10",stormDT$PROPDMGEXP)
stormDT$PROPDMGEXP<- gsub("H|h|2", "100" ,stormDT$PROPDMGEXP)
stormDT$PROPDMGEXP<- gsub("K|k|3", "1000" ,stormDT$PROPDMGEXP)
stormDT$PROPDMGEXP<- gsub("4"    , "10000" ,stormDT$PROPDMGEXP)
stormDT$PROPDMGEXP<- gsub("5"    , "100000" ,stormDT$PROPDMGEXP)
stormDT$PROPDMGEXP<- gsub("M|m|6", "1000000" ,stormDT$PROPDMGEXP)
stormDT$PROPDMGEXP<- gsub("7"    , "10000000" ,stormDT$PROPDMGEXP)
stormDT$PROPDMGEXP<- gsub("8"    , "100000000" ,stormDT$PROPDMGEXP)
stormDT$PROPDMGEXP<- gsub("B|b"  , "1000000000" ,stormDT$PROPDMGEXP)
stormDT$PROPDMGEXP <- as.numeric(as.character(stormDT$PROPDMGEXP))
sort(unique(stormDT$PROPDMGEXP))
stormDT$PROPCOST <- stormDT$PROPDMG * stormDT$PROPDMGEXP
```




```{r}
# Crop 
stormDT$CROPDMGEXP<- gsub("?", "0" ,stormDT$CROPDMGEXP)
stormDT$CROPDMGEXP<- gsub("H|h|2", "100" ,stormDT$CROPDMGEXP)
stormDT$CROPDMGEXP<- gsub("K|k|3", "1000" ,stormDT$CROPDMGEXP)
stormDT$CROPDMGEXP<- gsub("M|m"  , "1000000" ,stormDT$CROPDMGEXP)
stormDT$CROPDMGEXP<- gsub("B|b"  , "1000000000" ,stormDT$CROPDMGEXP)
stormDT$CROPDMGEXP <- as.numeric(as.character(stormDT$CROPDMGEXP))
sort(unique(stormDT$CROPDMGEXP))
stormDT$CROPCOST <- stormDT$CROPDMG * stormDT$CROPDMGEXP
```



#### Making plot
```{r}
# Total property cost
totalCost <- stormDT[, .(PROPCOST = sum(PROPCOST), CROPCOST = sum(CROPCOST),
                     TOTALCOST = sum(PROPCOST) + sum(CROPCOST)),
                     by = .(EVTYPE)]
totalCost <- totalCost[order(-TOTALCOST),]
totalCost <- totalCost[1 : 10,]
head(totalCost, 5)
```


```{r}
# Total health cost 
totalhealth <- stormDT[, .(FATALITIES = sum(FATALITIES), INJURIES = sum(INJURIES),
                           TOTALHEALTH = sum(FATALITIES) + sum(INJURIES)),
                       by = .(EVTYPE)]
totalhealth <- totalhealth[order(-TOTALHEALTH),]
totalhealth <- totalhealth[1:10,]
head(totalhealth, 5)
```


### **Results **


```{r}
# EVENTS WITH HIGHEST INJURIES
ggplot(totalhealth, aes(x = EVTYPE, y = INJURIES)) +
        geom_bar(stat = "identity") +
        labs(title = "EVENTS WITH HIGHEST INJURIES")
```


```{r}
# EVENTS WITH HIGHEST TATALITIES
ggplot(totalhealth, aes(x = EVTYPE, y = FATALITIES)) +
        geom_bar(stat = "identity") +
        labs(title = "EVENTS WITH HIGHEST FATALITIES")
```


```{r}
# EVENTS WITH HIGHEST PROPERTY DAMAGES
ggplot(totalCost, aes(x = EVTYPE, y = PROPCOST)) +
        geom_bar(stat = "identity") +
        labs(title = "EVENTS WITH HIGHEST PROPERTY DAMAGES")
```


```{r}
# EVENTS WITH HIGHEST CROP DAMAGES
ggplot(totalCost, aes(x = EVTYPE, y = CROPCOST)) +
        geom_bar(stat = "identity") +
        labs(title = "EVENTS WITH HIGHEST CROP DAMAGES")
```